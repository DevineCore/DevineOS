<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DivineOS // Persistence_Patch_v9</title>
<link rel="manifest" href="manifest.json">
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<style>
    :root { --bg: #0000AA; --win: #FFFFFF; --text: #000000; --accent: #AA0000; --highlight: #00AAAA; --dim: #AAAAAA; }
    * { box-sizing: border-box; user-select: none; }
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Courier New', monospace; background-color: #000; color: var(--text); cursor: crosshair; font-weight: bold; }

    /* BIOS SCREEN */
    #bios-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: black; color: white; padding: 20px; z-index: 999999; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 14px; }
    
    /* LOGIN UI */
    .login-box { border: 2px solid white; padding: 20px; width: 300px; text-align: center; }
    .login-box input { background: black; color: white; border: none; border-bottom: 2px solid white; font-family: inherit; font-size: 18px; text-align: center; width: 100%; margin: 10px 0; outline: none; }
    .login-box button { background: white; color: black; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; font-family: inherit; }
    .login-box button:hover { background: #ccc; }
    .error-msg { color: red; margin-top: 10px; display: none; }

    /* DESKTOP (Hidden by default) */
    #desktop { width: 100%; height: calc(100% - 40px); position: relative; background-image: radial-gradient(rgba(255,255,255,0.2) 1px, transparent 1px); background-size: 40px 40px; background-color: var(--bg); display: none; }
    #taskbar { position: absolute; bottom: 0; left: 0; width: 100%; height: 40px; background: var(--dim); border-top: 4px solid white; display: none; align-items: center; padding: 0 10px; z-index: 9999; }
    
    /* ICONS & WINDOWS (Minified styles for cleaner code) */
    .desktop-icon { position: absolute; width: 90px; height: 90px; text-align: center; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .icon-img { font-size: 32px; margin-bottom: 5px; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border: 4px double rgba(255,255,255,0.5); box-shadow: 3px 3px 0px rgba(0,0,0,0.5); }
    .window { position: absolute; background: var(--win); color: var(--text); border: 4px double var(--accent); box-shadow: 10px 10px 0px rgba(0,0,0,0.5); display: flex; flex-direction: column; min-width: 200px; min-height: 150px; }
    .title-bar { background: var(--accent); color: #FFFF55; padding: 5px; display: flex; justify-content: space-between; align-items: center; cursor: grab; border-bottom: 2px solid black; }
    .content { flex: 1; overflow: auto; position: relative; }
    .task-tab { background: white; border: 2px solid black; padding: 5px 10px; margin-right: 5px; cursor: pointer; font-size: 12px; box-shadow: 3px 3px 0px #555; color: black; }
    .close-btn { cursor: pointer; background: var(--highlight); color: white; border: 1px solid black; width: 20px; text-align: center; }
</style>
</head>
<body>

<div id="bios-screen">
    <div class="login-box" id="setup-box" style="display:none;">
        <h3>INITIAL SETUP</h3>
        <p>CREATE A PASSWORD</p>
        <input type="password" id="new-pass" placeholder="New Password">
        <button onclick="BIO.setupDrive()">ENCRYPT DRIVE</button>
    </div>

    <div class="login-box" id="unlock-box" style="display:none;">
        <h3>SECURE BOOT</h3>
        <p>DISK FOUND. DECRYPT?</p>
        <input type="password" id="unlock-pass" placeholder="Enter Password">
        <button onclick="BIO.unlockDrive()">UNLOCK</button>
        <div id="unlock-msg" class="error-msg">WRONG KEY</div>
        <div style="margin-top:20px; font-size:10px; color:#555; cursor:pointer;" onclick="BIO.factoryReset()">FORGOT PASSWORD? (RESET)</div>
    </div>
</div>

<div id="desktop"></div>
<div id="taskbar">
    <button onclick="BIO.runScript('/core/manifest.js')" style="font-weight:bold; padding:5px;">SYSTEM</button>
    <div id="task-list" style="display:flex; margin-left:10px;"></div>
    <div id="clock" style="margin-left:auto; color:blue;">00:00</div>
</div>

<script>
// --- CORE SYSTEM ---
const BIO = {
    zIndex: 100,
    fs: null,
    key: null,
    
    // DEFAULT FILE SYSTEM
    defaultFS: {
        root: {
            home: { type: 'dir', content: { "readme.txt": { type: 'file', content: "Welcome to Divine OS.\nFiles saved here persist after reboot." } } },
            system: { type: 'dir', content: { 
                "kernel.js": { type: 'file', content: `window.Kernel={activeWindows:{},createWindow:function(t,w,h,c,id){BIO.applyTheme();const i=id||'w'+Date.now();const d=document.createElement('div');d.className='window';d.id=i;d.style.width=w+'px';d.style.height=h+'px';d.style.top='50px';d.style.left='50px';d.style.zIndex=++BIO.zIndex;d.innerHTML='<div class="title-bar" onmousedown="Kernel.drag(event,\\''+i+'\\')"><span>'+t+'</span><div class="close-btn" onclick="Kernel.close(\\''+i+'\\')">X</div></div><div class="content">'+c+'</div>';document.getElementById('desktop').appendChild(d);const b=document.createElement('div');b.className='task-tab';b.innerText=t;b.onclick=()=>d.style.zIndex=++BIO.zIndex;b.id='t-'+i;document.getElementById('task-list').appendChild(b)},close:function(i){document.getElementById(i).remove();document.getElementById('t-'+i).remove()},drag:function(e,i){const w=document.getElementById(i);w.style.zIndex=++BIO.zIndex;let x=e.clientX-w.offsetLeft,y=e.clientY-w.offsetTop;document.onmousemove=ev=>{w.style.left=(ev.clientX-x)+'px';w.style.top=(ev.clientY-y)+'px'};document.onmouseup=()=>{document.onmousemove=null}}}` },
                "boot.js": { type: 'file', content: `BIO.applyTheme(); const icons=[{n:'NOTE',r:'/core/notepad.js',x:0},{n:'FILES',r:'/core/manifest.js',x:1},{n:'SETTINGS',r:'/core/config.js',x:2}]; icons.forEach((i,idx)=>{const d=document.createElement('div');d.className='desktop-icon';d.style.top='20px';d.style.left=(20+idx*100)+'px';d.innerHTML='<div class="icon-img" style="background:gray">APP</div>'+i.n;d.onclick=()=>BIO.runScript(i.r);document.getElementById('desktop').appendChild(d)})` },
                "config.json": { type: 'file', content: `{"theme":{"--bg":"#0000AA","--win":"#FFFFFF","--text":"#000000","--accent":"#AA0000"}}` }
            }},
            core: { type: 'dir', content: {
                "notepad.js": { type: 'file', content: `const id='n'+Date.now();Kernel.createWindow('NOTEPAD',400,300,'<textarea id="tx'+id+'" style="width:100%;height:80%;"></textarea><button onclick="BIO.saveFile(\\'/home/note.txt\\',document.getElementById(\\'tx'+id+'\\').value)">SAVE /home/note.txt</button>',id)` },
                "manifest.js": { type: 'file', content: `const id='m'+Date.now();let h='<div style="padding:10px">';const r=BIO.resolve('/home');for(let k in r)h+='<div>ðŸ“„ '+k+'</div>';h+='</div>';Kernel.createWindow('FILES',300,300,h,id)` },
                "config.js": { type: 'file', content: `Kernel.createWindow('CONFIG',300,200,'<button onclick="BIO.factoryReset()">FACTORY RESET</button>')` }
            }}
        }
    },

    // --- INITIALIZATION ---
    init: function() {
        // 1. Install PWA Logic
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
        
        // 2. Check for Existing Drive
        const disk = localStorage.getItem('divineOS_disk');
        
        if (disk) {
            // Drive exists -> Show Unlock Screen
            document.getElementById('setup-box').style.display = 'none';
            document.getElementById('unlock-box').style.display = 'block';
        } else {
            // No Drive -> Show Setup Screen
            document.getElementById('setup-box').style.display = 'block';
            document.getElementById('unlock-box').style.display = 'none';
        }
    },

    // --- SETUP NEW DRIVE ---
    setupDrive: function() {
        const p = document.getElementById('new-pass').value;
        if(!p) return alert("PASSWORD REQUIRED");
        
        BIO.key = p;
        BIO.fs = JSON.parse(JSON.stringify(BIO.defaultFS));
        BIO.saveToDisk(); // Initial Encrypted Save
        BIO.boot();
    },

    // --- UNLOCK EXISTING DRIVE ---
    unlockDrive: function() {
        const p = document.getElementById('unlock-pass').value;
        const disk = localStorage.getItem('divineOS_disk');
        
        try {
            const bytes = CryptoJS.AES.decrypt(disk, p);
            const str = bytes.toString(CryptoJS.enc.Utf8);
            
            if (!str) throw "FAIL";
            
            // Success!
            BIO.key = p;
            BIO.fs = JSON.parse(str);
            BIO.boot();
            
        } catch(e) {
            document.getElementById('unlock-msg').style.display = 'block';
            document.getElementById('unlock-pass').value = '';
        }
    },

    // --- BOOT SEQUENCE ---
    boot: function() {
        document.getElementById('bios-screen').style.display = 'none';
        document.getElementById('desktop').style.display = 'block';
        document.getElementById('taskbar').style.display = 'flex';
        
        // Load Kernel & Boot Scripts
        const k = BIO.resolve('/system/kernel.js');
        if(k) new Function(k.content)();
        
        const b = BIO.resolve('/system/boot.js');
        if(b) new Function(b.content)();
        
        // Start Clock
        setInterval(()=>document.getElementById('clock').innerText=new Date().toLocaleTimeString(),1000);
    },

    // --- FILE SYSTEM API ---
    resolve: function(path) {
        const parts = path.split('/').filter(p=>p);
        let c = BIO.fs.root;
        for(let p of parts) {
            if(c.type==='dir' && c.content[p]) c = c.content[p];
            else if(c[p]) c = c[p];
            else return null;
        }
        return c.type==='dir' ? c.content : c;
    },

    saveFile: function(path, content) {
        const parts = path.split('/').filter(p=>p);
        const name = parts.pop();
        let c = BIO.fs.root;
        for(let p of parts) {
            if(!c[p]) c[p] = {type:'dir',content:{}};
            c = c[p].content;
        }
        c[name] = {type:'file', content:content};
        BIO.saveToDisk(); // AUTO-SAVE ON CHANGE
        alert("SAVED: "+name);
    },

    saveToDisk: function() {
        if(!BIO.key) return;
        const str = JSON.stringify(BIO.fs);
        const enc = CryptoJS.AES.encrypt(str, BIO.key).toString();
        localStorage.setItem('divineOS_disk', enc);
    },
    
    runScript: function(path) {
        const f = BIO.resolve(path);
        if(f) new Function(f.content)();
    },

    applyTheme: function() {
        try {
            const f = BIO.resolve('/system/config.json');
            const c = JSON.parse(f.content);
            for(let k in c.theme) document.documentElement.style.setProperty(k, c.theme[k]);
        } catch(e){}
    },

    factoryReset: function() {
        if(confirm("DESTROY DATA? CANNOT BE UNDONE.")) {
            localStorage.removeItem('divineOS_disk');
            location.reload();
        }
    }
};

window.onload = BIO.init;
</script>
</body>
</html>
